name: Reusable - Deployment
on:
    workflow_call: 
        inputs:
            ENVIRONMENT:
              required: true
              type: string
        outputs:
          application_url:
            value: ${{ jobs.reuse-deploy.outputs.DEV_URL }}
        
jobs:
    reuse-deploy:
      runs-on: ubuntu-latest
      outputs:
        DEV_URL: ${{ steps.Get_Url.outputs.URL}}
      environment: 
        name: ${{ inputs.ENVIRONMENT }}
        url: https://${{ steps.Get_Url.outputs.URL }}
      steps:
        - name: Checkout Repo
          uses: actions/checkout@v4
        - name: Setup Kubectl
          uses: azure/setup-kubectl@v4
        - name: Set KubeConfig
          uses: azure/k8s-set-context@v4
          with:
            method: kubeconfig
            kubeconfig: ${{ secrets.KUBECONFIG }}
            context: kubernetes-admin@kubernetes
        - name: Check Namespace Exist
          run: |
            if ! kubectl get namespace ${{ vars.NAMESPACE }} > /dev/null 2>&1 ; then
              kubectl create namespace ${{ vars.NAMESPACE }}
            else
              echo "Namespace ${{ vars.NAMESPACE }} Already Exist"
            fi
        - name: Create Secret 
          run: |
            kubectl -n ${{ vars.NAMESPACE }} create secret generic mongo-db-creds --from-literal=MONGO_URI=${{ secrets.MONGO_URI }} \
            --save-config \
            --dry-run=client \
            -o yaml | kubectl apply -f -
        - name: create tls secret
          run: |
            set -euo pipefail
            echo "${{ secrets.CERT }}" > tls.crt
            echo "${{ secrets.CERT }}" > tls.key
            kubectl -n ${{ vars.NAMESPACE }} create secret tls solar --cert=tls.crt \
            --key=tls.key \
            --dry-run=client \
            -o yaml | kubectl apply -f -
        - name: Replace Token Manifest
          uses: cschleiden/replace-tokens@v1
          with:
            tokenPrefix: '_{_'
            tokenSuffix: '_}_'
            files: '["kubernetes/${{ vars.ENVIRONMENT }}/*.yaml"]'
          env:
            REPLICAS: ${{ vars.REPLICAS }}
            NAMESPACE: ${{ vars.NAMESPACE }}
            K8S_IMAGE: ${{ vars.DOCKER_USER}}/solar-system:${{ github.sha }}
            MESSAGE: "Deploy: ${{ github.event.head_commit.message }} (by ${{ github.actor }})"
        - name: Apply Deployment
          run: |
            kubectl apply -f kubernetes/${{ vars.ENVIRONMENT }}/
        - name: Get URL
          id: Get_Url
          run: |
            echo "URL=$(kubectl get ingress -n ${{ vars.NAMESPACE }} ingress-solar -o jsonpath="{.spec.rules[0].host}")" >> "$GITHUB_OUTPUT"